---
title: Turborepo
description: How I Use Turborepo
---

# How I Use Turborepo

## Table Of Contents

{/* Generated placeholder; add anchors as needed */}

## Table Of Contents

{/* Generated placeholder; add anchors as needed */}

## Table Of Contents

{/* Generated placeholder; add anchors as needed */}

My standard monorepo setup for -xyz projects. Every web project follows this exact pattern.

## Project Structure

```
project-xyz/
├── apps/
│   ├── app/        # Main Next.js 15 app (customer-facing)
│   ├── web/        # Marketing/landing pages
│   ├── api/        # Cloudflare Worker API (Hono)
│   └── ai/         # Mastra AI service (preferred)
├── packages/
│   ├── auth/       # Clerk integration & utilities
│   ├── database/   # Drizzle schemas, migrations & client
│   ├── design/     # UI components (React 19, Tailwind v4)
│   └── services/   # Business logic & data operations
├── turbo.json
├── package.json
├── pnpm-workspace.yaml
└── biome.json
```

## Core Configuration

### turbo.json
```json
{
  "$schema": "https://turbo.build/schema.json",
  "ui": "stream",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", "!.next/cache/**"],
      "env": ["NODE_ENV", "NEXT_PUBLIC_*", "CLERK_*", "DATABASE_URL"]
    },
    "dev": {
      "persistent": true,
      "cache": false,
      "dotEnv": [".env.*local", ".env"]
    },
    "lint": {
      "dependsOn": ["^build"]
    },
    "type-check": {
      "dependsOn": ["^build"]
    },
    "migrate": {
      "cache": false,
      "inputs": ["packages/database/src/schema.ts"]
    }
  }
}
```

### Root package.json
```json
{
  "name": "project-xyz",
  "private": true,
  "scripts": {
    "dev": "turbo dev",
    "build": "turbo build",
    "start": "turbo start",
    "lint": "turbo lint",
    "type-check": "turbo type-check",
    "clean": "turbo clean && rm -rf node_modules",
    "db:migrate": "pnpm --filter @project/database migrate",
    "db:studio": "pnpm --filter @project/database studio"
  },
  "devDependencies": {
    "turbo": "^2.0.0",
    "typescript": "^5.5.0"
  },
  "packageManager": "pnpm@9.1.4"
}
```

### pnpm-workspace.yaml
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

## Package Patterns

### Workspace References
Always use `workspace:*` for internal packages:
```json
{
  "dependencies": {
    "@project/database": "workspace:*",
    "@project/design": "workspace:*",
    "@project/services": "workspace:*"
  }
}
```

### Package Architecture Philosophy

**No Separate Type/API/Schema Packages** - I keep things simple:
- Types are generated by Drizzle schemas (drizzle-zod)
- API types come from the actual API implementation
- Business logic lives in services package
- Database schemas stay in database package

### packages/database
Contains Drizzle schemas, migrations, and database client:
```typescript
// src/schema.ts - Single source of truth
export const users = pgTable('users', {
  id: text('id').primaryKey(),
  email: text('email').notNull(),
  createdAt: timestamp('created_at').defaultNow()
});

// Types are automatically generated
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;

// Zod schemas via drizzle-zod
export const insertUserSchema = createInsertSchema(users);
export const selectUserSchema = createSelectSchema(users);
```

### packages/services
All business logic and data operations:
```typescript
// src/users.ts
import { db } from '@project/database';
import { users } from '@project/database/schema';

export async function createUser(data: NewUser) {
  return db.insert(users).values(data).returning();
}

export async function getUserById(id: string) {
  return db.select().from(users).where(eq(users.id, id));
}
```

## Task Patterns

### Development Workflow
```bash
# Start Everything
pnpm dev

# Build For Production
pnpm build

# Type Checking Across Monorepo
pnpm type-check

# Database Operations
pnpm db:migrate      # Run migrations
pnpm db:studio       # Open Drizzle Studio
pnpm db:push         # Push schema changes (dev only)
```

## Environment Variables
- Use `.env.*local` files (gitignored)
- Reference in turbo.json for caching
- Prefix Next.js public vars with `NEXT_PUBLIC_`

## Common Scripts Per App

### apps/app (Next.js)
```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "biome check .",
    "type-check": "tsc --noEmit"
  }
}
```

### apps/api (Cloudflare Worker)
```json
{
  "scripts": {
    "dev": "wrangler dev",
    "build": "wrangler deploy --dry-run --outdir dist",
    "deploy": "wrangler deploy",
    "type-check": "tsc --noEmit"
  }
}
```

### packages/database
```json
{
  "scripts": {
    "generate": "drizzle-kit generate",
    "migrate": "drizzle-kit migrate",
    "push": "drizzle-kit push",
    "studio": "drizzle-kit studio",
    "type-check": "tsc --noEmit"
  }
}
```

### packages/services
```json
{
  "scripts": {
    "type-check": "tsc --noEmit",
    "test": "vitest"
  }
}
```

## Integration Points

### Typescript Configuration
Root tsconfig.json with:
- `"strict": true`
- Path aliases for packages
- Module resolution: "bundler"
- Target: "ES2020"

### Biome Configuration
Single biome.json at root:
- Extends "ultracite" 
- 2-space indentation
- Single quotes
- Ignores build directories

### Database Connection
- Local: Direct PostgreSQL connection
- Production: Via Hyperdrive (Cloudflare) or connection pooling
- Always use prepared statements

## My Conventions

1. **Always use pnpm** - Never npm or yarn
2. **Stream UI mode** - Better DX for debugging
3. **Workspace protocol** - For all internal deps
4. **Consistent naming** - `@project/package` format
5. **Single source of truth** - Drizzle schemas define everything
6. **Services pattern** - All business logic in services
7. **Environment files** - `.env.*local` pattern
8. **No unnecessary abstractions** - Types come from implementation

## Common Commands

```bash
# Add Dependency To Specific Package
pnpm --filter @project/app add some-package

# Run Command In Specific Package
pnpm --filter @project/database migrate

# Update All Dependencies
pnpm update -r

# Clean Everything
pnpm clean && pnpm install

# Build Specific App
pnpm build --filter @project/app

# Run Dev With Specific Filter
pnpm dev --filter @project/app --filter @project/api
```

## Project Bootstrap

Starting a new project:
```bash
# Create Monorepo Structure
mkdir project-xyz && cd project-xyz
pnpm init

# Set Up Workspace
echo "packages:\n  - 'apps/*'\n  - 'packages/*'" > pnpm-workspace.yaml

# Create Apps
mkdir -p apps/{app,api,ai}

# Create Packages  
mkdir -p packages/{auth,database,design,services}

# Install Turbo
pnpm add -D turbo typescript

# Copy Configs From Existing Project
cp ../other-xyz/{turbo.json,biome.json,tsconfig.json} .
```

## Gotchas & Solutions

1. **Module resolution issues** → Check tsconfig paths and build order
2. **Cache problems** → Run `turbo clean`
3. **Env var not available** → Add to turbo.json env array
4. **Type errors in packages** → Ensure packages are built first
5. **Database connection in dev** → Check DATABASE_URL in .env.local

## Why This Structure

- **No API package**: API types come from implementation
- **No schemas package**: Drizzle schemas are the source
- **No types package**: Types are inferred/generated
- **Services for logic**: Clean separation of concerns
- **Simple > Complex**: Fewer packages = less overhead

## Resources & Links

### Official Documentation
- [Turborepo Docs](https://turbo.build/repo/docs)
- [Getting Started](https://turbo.build/repo/docs/getting-started)
- [Configuration](https://turbo.build/repo/docs/reference/configuration)
- [CLI Reference](https://turbo.build/repo/docs/reference/command-line-reference)

### Core Concepts
- [Pipelines](https://turbo.build/repo/docs/core-concepts/monorepos/running-tasks)
- [Caching](https://turbo.build/repo/docs/core-concepts/caching)
- [Remote Caching](https://turbo.build/repo/docs/core-concepts/remote-caching)
- [Filtering](https://turbo.build/repo/docs/core-concepts/monorepos/filtering)

### Package Manager
- [pnpm Workspaces](https://pnpm.io/workspaces)
- [pnpm CLI](https://pnpm.io/cli/install)
- [Workspace Protocol](https://pnpm.io/workspaces#workspace-protocol-workspace)
- [Filtering](https://pnpm.io/filtering)

### Integration Guides
- [Next.js with Turborepo](https://turbo.build/repo/docs/handbook/tools/nextjs)
- [TypeScript](https://turbo.build/repo/docs/handbook/tools/typescript)
- [Docker](https://turbo.build/repo/docs/handbook/tools/docker)
- [CI/CD](https://turbo.build/repo/docs/ci)

## See Also

- [Patterns](/architecture/patterns)
- [Cicd](/stack/cicd/cicd)
- [Testing](/stack/testing/testing)
